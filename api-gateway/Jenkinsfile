pipeline {
    agent any

    environment {
        DOCKERHUB_USERNAME = 'juansmc'
        SERVICE_NAME = 'api-gateway'
        IMAGE_NAME = "${DOCKERHUB_USERNAME}/api-gateway-ecommerce-boot"
        IMAGE_TAG = "${env.BRANCH_NAME}-${env.BUILD_NUMBER}"
        KUBE_NAMESPACE = 'development'
        DOCKER_CREDENTIALS_ID = 'dockerhub-creds'
        KUBE_MANIFESTS_DIR = 'k8s'
        KUBE_DEPLOYMENT_FILE = "${KUBE_MANIFESTS_DIR}/${SERVICE_NAME}-container-deployment.yaml"
        KUBE_SERVICE_FILE = "${KUBE_MANIFESTS_DIR}/${SERVICE_NAME}-service.yaml"
    }

    stages {
        stage('1. Checkout') {
            steps {
                echo "Clonando el repositorio..."
                checkout scm
                echo "Checkout completado para la rama: ${env.BRANCH_NAME}"
            }
        }

        stage('2. Maven Build & Test') {
            steps {
                script {
                    dir("${env.SERVICE_NAME}") {
                        if (env.BRANCH_NAME == 'stage') {
                            echo "Ejecutando build con tests para stage..."
                            sh 'mvn clean verify'
                        } else {
                            echo "Ejecutando build sin tests para dev..."
                            sh 'mvn clean package -DskipTests'
                        }
                    }
                }
            }
        }

        stage('3. Build & Push Docker Image') {
            steps {
                script {
                    echo "Construyendo y subiendo la imagen: ${env.IMAGE_NAME}:${env.IMAGE_TAG}"
                    docker.withRegistry('https://registry.hub.docker.com', env.DOCKER_CREDENTIALS_ID) {
                        dir("${env.SERVICE_NAME}") {
                            def customImage = docker.build("${env.IMAGE_NAME}:${env.IMAGE_TAG}", ".")
                            customImage.push()
                        }
                    }
                    echo "Imagen subida exitosamente."
                }
            }
        }

        stage('4. Update K8s Manifests') {
            when {
                anyOf {
                    branch 'dev'
                    branch 'stage'
                }
            }
            steps {
                echo "Actualizando la imagen en ${env.KUBE_DEPLOYMENT_FILE}..."
                sh "sed -i 's|image: .*|image: ${env.IMAGE_NAME}:${env.IMAGE_TAG}|g' ${env.KUBE_DEPLOYMENT_FILE}"
                echo "Manifest actualizado:"
                sh "cat ${env.KUBE_DEPLOYMENT_FILE}"
            }
        }

        stage('5. Deploy to Dev K8s') {
            when {
                branch 'dev'
            }
            steps {
                echo "Desplegando ${env.SERVICE_NAME} en Kubernetes (Namespace: ${env.KUBE_NAMESPACE})..."
                sh "kubectl apply -f ${env.KUBE_SERVICE_FILE} -n ${env.KUBE_NAMESPACE}"
                sh "kubectl apply -f ${env.KUBE_DEPLOYMENT_FILE} -n ${env.KUBE_NAMESPACE}"
                sh "kubectl rollout status deployment/${env.SERVICE_NAME}-container -n ${env.KUBE_NAMESPACE} --timeout=120s"
                echo "¡Despliegue completado!"
            }
        }
    }

    post {
        always {
            echo 'Limpiando el workspace...'
            cleanWs()
        }
        success {
            echo '¡El pipeline se ejecutó exitosamente!'
        }
        failure {
            echo '¡El pipeline falló!'
        }
    }
}
